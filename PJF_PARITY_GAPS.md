# dprint-plugin-java vs PJF: Key Discrepancies Found

## Quick Stats
- **Files compared**: 473
- **Performance**: dprint 46x faster (0.2s vs 10s)
- **Exact match (normalized)**: 42.5% (201/473 files)
- **Files with differences**: 57.5% (272/473 files)

## Top 5 Discrepancies (Prioritized by Impact)

### 1. ❌ **Blank Lines Between Members** (HIGH - affects 272 files)
**Current dprint behavior**: Adds blank line after class `{` and between ALL field declarations
**PJF behavior**: NO blank line after class `{`, fields compact together

```java
// DPRINT (current)
public class SDK {
                    ← extra blank line
    private static final Headers headers = Headers.EMPTY;
                    ← extra blank line
    private final AsyncSDK asyncSDK;
                    ← extra blank line
    private SDKConfiguration config;

// PJF (expected)
public class SDK {
    private static final Headers headers = Headers.EMPTY;
    private final AsyncSDK asyncSDK;
    private SDKConfiguration config;
```

**Root cause**: Task #19 (blank line placement) added blank lines after class brace and between members
**Fix needed**: Remove blank line insertion logic for consecutive field declarations

---

### 2. ❌ **Argument List Wrapping Heuristics** (HIGH - affects 92 files)
**Current dprint behavior**: Wraps arguments even when they fit on continuation line
**PJF behavior**: Keeps args on one line if total width < 120 chars

```java
// DPRINT (current) - wraps unnecessarily
public static final String USER_AGENT = String.format(
        "speakeasy-sdk/%s %s %s %s %s",
        LANGUAGE,
        SDK_VERSION,
        GEN_VERSION,
        OPENAPI_DOC_VERSION,
        BASE_PACKAGE);

// PJF (expected) - keeps on one line
public static final String USER_AGENT = String.format(
        "speakeasy-sdk/%s %s %s %s %s", LANGUAGE, SDK_VERSION, GEN_VERSION, OPENAPI_DOC_VERSION, BASE_PACKAGE);
```

**Root cause**: `estimate_argument_list_width()` doesn't check if wrapped line fits in continuation
**Fix needed**: Add heuristic: if all args fit on ONE continuation line, don't wrap individually

---

### 3. ❌ **Method Chain First Call Wrapping** (MEDIUM - affects 50 files)
**Current dprint behavior**: Keeps first call on same line as base object
**PJF behavior**: Wraps first call to new line when chain is long

```java
// DPRINT (current)
contextRunner.withUserConfiguration(CustomConfig.class)
        .withPropertyValues("key=value")
        .run(ctx -> { ... });

// PJF (expected)
contextRunner
        .withUserConfiguration(CustomConfig.class)
        .withPropertyValues("key=value")
        .run(ctx -> { ... });
```

**Root cause**: Task #13 (chain wrapping) only wraps at `.` if exceeds threshold, doesn't force-wrap first call
**Fix needed**: When wrapping chain, wrap first call too (builder pattern convention)

---

### 4. ⚠️ **Generic Type Parameter Wrapping** (LOW - observed in complex cases)
**Current dprint behavior**: Wraps long generic type on same line as variable
**PJF behavior**: Wraps type params vertically, indents closing `>` with variable name

```java
// DPRINT (current)
RequestOperation<OperationWithLongName, ResponseWithLongName> operation =
        new Operation.Sync(config, headers);

// PJF (expected)
RequestOperation<
                OperationWithLongName,
                ResponseWithLongName>
        operation = new Operation.Sync(config, headers);
```

**Root cause**: Type argument wrapping uses horizontal layout
**Fix needed**: Detect long type arguments, wrap vertically with deep indent for alignment

---

### 5. ⚠️ **Blank Line After Copyright Header** (LOW - cosmetic)
**Current dprint behavior**: No blank line after `*/` before `package`
**PJF behavior**: Adds blank line after block comment before `package`

```java
// DPRINT (current)
/*
 * Code generated by Speakeasy...
 */
package org.openapis.review.openapi;

// PJF (expected)
/*
 * Code generated by Speakeasy...
 */
                    ← blank line
package org.openapis.review.openapi;
```

**Root cause**: Comment handling doesn't insert blank after block comment before package
**Fix needed**: Add blank line if package declaration immediately follows block comment

---

## Annotation Placement (109 files affected)
**Note**: This is NOT a standalone issue - it's a symptom of issue #3 (chain wrapping)

The annotation differences occur when method chains are wrapped differently:
```java
// DPRINT
@Test
void test() {
    runner.withConfig(...)
            .run(...);
}

// PJF (wraps first call differently)
@Test
void test() {
    runner
            .withConfig(...)
            .run(...);
}
```

Once chain wrapping is fixed, annotation placement will match automatically.

---

## Implementation Priority

### Phase 1: High Impact (Gets to 80%+ parity)
1. **Remove blank lines between fields** - easy fix, huge impact
2. **Fix argument list wrapping** - medium difficulty, high impact

### Phase 2: Medium Impact (Gets to 95%+ parity)
3. **Fix chain first-call wrapping** - medium difficulty, fixes annotation issues too

### Phase 3: Low Impact (Edge cases)
4. Generic type parameter wrapping - low frequency
5. Copyright header blank line - cosmetic only

---

## Test Files Created
New spec tests in `tests/specs/pjf_parity/`:
- `blank_lines_members.txt` - shows dprint adds extra blank lines
- `short_args_one_line.txt` - shows dprint wraps args unnecessarily
- `chain_first_call_wrap.txt` - shows chain wrapping difference
- `generic_type_wrap.txt` - shows type parameter wrapping gap
- `header_blank_line.txt` - shows copyright header spacing

All tests currently FAIL (expected vs actual mismatch) - they document the gaps.

---

## Files Available for Debugging
- Comparison workspace: `/tmp/fmt-comparison/`
- dprint output: `/tmp/fmt-comparison/dprint/`
- PJF output: `/tmp/fmt-comparison/spotless-runner/src/`
- Full report: `/home/vgd/c/speakeasy-api/dprint-plugin-java/PJF_COMPARISON_REPORT.md`
